<div id="page4-wrapper">
    <style>
        /* --- SCOPED THEME UI --- */
        #page4-wrapper {
            font-family: 'Segoe UI', sans-serif;
            background-color: #050505;
            color: #fff;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            min-height: 100%;
        }

        #page4-wrapper .container {
            background: #111;
            padding: 0;
            /* ZERO PADDING requested */
            width: 100%;
            max-width: none;
            border: none;
            text-align: center;
            min-height: 100vh;
        }

        /* HEADER & STATUS */
        #page4-wrapper .top-bar {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #777;
            margin-bottom: 10px;
            padding: 10px;
            /* Internal padding */
        }

        /* SPLIT VIEW */
        #page4-wrapper .split-box {
            display: flex;
            gap: 0;
            /* Remove gap if borderless feel needed, or keep small */
            margin-bottom: 15px;
            padding: 0 10px;
        }

        #page4-wrapper .half {
            flex: 1;
            background: #1a1a1a;
            padding: 10px;
            border-radius: 0;
            /* Remove radius */
            border: none;
            /* Remove border */
            border-right: 1px solid #333;
            /* Optional separator */
        }

        #page4-wrapper .half:last-child {
            border-right: none;
        }

        #page4-wrapper .lbl {
            font-size: 0.6em;
            color: #aaa;
            text-transform: uppercase;
            display: block;
            margin-bottom: 5px;
        }

        #page4-wrapper .big-txt {
            font-weight: 900;
            font-size: 1.5em;
        }

        /* STRATEGY GRID */
        #page4-wrapper .grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
            margin-bottom: 15px;
            padding: 0 10px;
        }

        #page4-wrapper .card {
            background: #222;
            padding: 8px;
            border-radius: 6px;
        }

        #page4-wrapper .c-title {
            font-size: 0.6em;
            color: #888;
            display: block;
            text-transform: uppercase;
        }

        #page4-wrapper .c-val {
            font-weight: bold;
            font-size: 1.1em;
        }

        #page4-wrapper .b-gold {
            border-bottom: 2px solid gold;
        }

        #page4-wrapper .b-silv {
            border-bottom: 2px solid silver;
        }

        #page4-wrapper .b-bron {
            border-bottom: 2px solid #cd7f32;
        }

        /* LOGS */
        #page4-wrapper .logs {
            height: 250px;
            overflow-y: auto;
            background: #000;
            border-top: 1px solid #333;
            /* Only top border */
            border-radius: 0;
            padding: 10px;
            text-align: left;
            font-family: monospace;
            font-size: 0.85em;
        }

        #page4-wrapper .row {
            border-bottom: 1px solid #222;
            padding: 5px 0;
            display: flex;
            justify-content: space-between;
        }

        #page4-wrapper .win {
            color: #00e676;
        }

        #page4-wrapper .loss {
            color: #ff4757;
        }

        #page4-wrapper .skip {
            color: #555;
        }

        /* UTILS */
        #page4-wrapper .c-Big {
            color: #ff4757;
        }

        #page4-wrapper .c-Small {
            color: #00e676;
        }

        #page4-wrapper .c-Wait {
            color: #555;
        }

        #page4-wrapper .controls {
            margin-bottom: 10px;
            padding: 0 10px;
        }

        #page4-wrapper button {
            background: #2980b9;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
        }

        #page4-wrapper button:active {
            transform: scale(0.99);
        }

        #page4-wrapper .timer-box {
            font-family: monospace;
            color: #f1c40f;
            font-weight: bold;
        }
    </style>

    <div class="container">
        <div class="top-bar"> <span>CLOCK: <span id="clock" style="color:white;">--:--:--</span></span> <span
                class="timer-box" id="nextScan">Next: --s</span> </div>
        <div class="split-box">
            <div class="half"> <span class="lbl">LAST RESULT</span>
                <div id="lastResDisplay" style="font-size:1.2em; font-weight:bold;">---</div>
                <div id="lastPerDisplay" style="font-size:0.8em; color:#666;">...</div>
            </div>
            <div class="half"> <span class="lbl">NEXT TARGET</span>
                <div id="mainPred" class="big-txt c-Wait">---</div>
                <div id="nextPerDisplay" style="font-size:0.8em; color:#00e676;">...</div>
            </div>
        </div>
        <div class="grid">
            <div class="card b-gold"><span class="c-title">ðŸ¥‡ Link</span><span id="gVal" class="c-val">-</span></div>
            <div class="card b-silv"><span class="c-title">ðŸ¥ˆ Neural</span><span id="sVal" class="c-val">-</span></div>
            <div class="card b-bron"><span class="c-title">ðŸ¥‰ Time</span><span id="bVal" class="c-val">-</span></div>
        </div>
        <div class="controls"> <button id="btnFetch">Force Manual Fetch</button> </div>
        <div id="logBox" class="logs">
            <div style="text-align:center; padding:20px; color:#444;">Waiting for :02 seconds...</div>
        </div>
    </div>

    <script>
        (function () {
            // --- STATE ---
            let lastKnownPeriod = "0"; // String to prevent math error
            let activePrediction = null;
            let hasFetchedThisMinute = false; // Flag to prevent double fetch
            let timerInterval = null;

            // Cleanup function to stop interval if component unmounts (wrapper removed)
            function checkCleanup() {
                if (!document.getElementById('page4-wrapper')) {
                    if (timerInterval) clearInterval(timerInterval);
                    return true;
                }
                return false;
            }

            // --- 1. MATH LOGIC ---
            function calculate(periodStr, resultNum) {
                const min = new Date().getMinutes() % 10;
                const curP_LastDigit = parseInt(periodStr.slice(-1));
                const nextP_LastDigit = (curP_LastDigit + 1) % 10;
                const s1 = ((nextP_LastDigit + resultNum) % 10) >= 5 ? "Big" : "Small";

                let v2 = (resultNum * 2) + min;
                if (resultNum === 0 || resultNum === 5) v2 += 1;
                const s2 = (v2 % 10) >= 5 ? "Big" : "Small";

                const s3 = Math.abs(min - resultNum) >= 5 ? "Big" : "Small";

                // Consensus
                const bigs = [s1, s2, s3].filter(x => x === "Big").length;
                const final = bigs >= 2 ? "Big" : "Small";

                return { gold: s1, silver: s2, bronze: s3, final: final };
            }

            // --- 2. FETCH FUNCTION (Direct - No Proxy) ---
            async function fetchData() {
                if (checkCleanup()) return;

                const ts = Date.now();
                const url = `https://draw.ar-lottery01.com/WinGo/WinGo_1M/GetHistoryIssuePage.json?ts=${ts}`;

                try {
                    // Visual Indicator
                    const scanEl = document.getElementById('nextScan');
                    if (scanEl) {
                        scanEl.innerText = "FETCHING...";
                        scanEl.style.color = "#00e676";
                    }

                    const res = await fetch(url);
                    const data = await res.json();

                    if (data?.data?.list?.length) {
                        const latest = data.data.list[0];
                        const serverPeriodStr = String(latest.issueNumber);
                        const resultNum = parseInt(latest.number);
                        const resultOutcome = resultNum >= 5 ? "Big" : "Small";

                        // CHECK IF NEW PERIOD
                        if (serverPeriodStr !== lastKnownPeriod) {
                            // 1. Check Win/Loss of Previous
                            if (activePrediction) {
                                if (activePrediction.period === serverPeriodStr) {
                                    const isWin = (activePrediction.pick === resultOutcome);
                                    addLog(serverPeriodStr, `${activePrediction.pick} vs ${resultOutcome}`, isWin ? "win" : "loss");
                                } else {
                                    // If period ID jumped
                                    addLog(activePrediction.period, "Skipped", "skip");
                                }
                            }

                            // 2. Update State
                            lastKnownPeriod = serverPeriodStr;

                            // 3. Calc Next Target
                            const nextPeriodBigInt = BigInt(serverPeriodStr) + 1n;
                            const targetPeriodStr = nextPeriodBigInt.toString();

                            const strats = calculate(serverPeriodStr, resultNum);

                            // 4. Update UI
                            const lastResEl = document.getElementById('lastResDisplay');
                            if (lastResEl) {
                                lastResEl.innerText = `${resultNum} (${resultOutcome})`;
                                lastResEl.className = "c-" + resultOutcome;
                            }

                            const lastPerEl = document.getElementById('lastPerDisplay');
                            if (lastPerEl) lastPerEl.innerText = "..." + serverPeriodStr.slice(-4);

                            const mainPredEl = document.getElementById('mainPred');
                            if (mainPredEl) {
                                mainPredEl.innerText = strats.final;
                                mainPredEl.className = "big-txt c-" + strats.final;
                            }

                            const nextPerEl = document.getElementById('nextPerDisplay');
                            if (nextPerEl) nextPerEl.innerText = "..." + targetPeriodStr.slice(-4);

                            updateCard('gVal', strats.gold);
                            updateCard('sVal', strats.silver);
                            updateCard('bVal', strats.bronze);

                            // 5. Store Prediction
                            activePrediction = { period: targetPeriodStr, pick: strats.final };
                        }
                    }
                } catch (e) {
                    console.error("Fetch Error:", e);
                    const scanEl = document.getElementById('nextScan');
                    if (scanEl) {
                        scanEl.innerText = "ERROR";
                        scanEl.style.color = "#ff4757";
                    }
                }
            }

            // --- 3. TIMING ENGINE ---
            timerInterval = setInterval(() => {
                if (checkCleanup()) return;

                const now = new Date();
                const s = now.getSeconds();

                // Update Clock UI
                const clockEl = document.getElementById('clock');
                if (clockEl) clockEl.innerText = now.toLocaleTimeString('en-US', { hour12: false });

                // Countdown UI
                let diff = 62 - s;
                if (diff > 60) diff -= 60;

                const scanEl = document.getElementById('nextScan');
                if (scanEl && scanEl.innerText !== "FETCHING...") {
                    scanEl.innerText = `Scan in: ${diff}s`;
                    scanEl.style.color = "#f1c40f";
                }

                // RESET FLAG at Second 50
                if (s > 50) {
                    hasFetchedThisMinute = false;
                }

                // TRIGGER AT SECOND 02
                if (s === 2 && !hasFetchedThisMinute) {
                    hasFetchedThisMinute = true;
                    fetchData();
                }
            }, 1000);

            // --- UI HELPERS ---
            function updateCard(id, val) {
                const el = document.getElementById(id);
                if (el) {
                    el.innerText = val;
                    el.className = "c-val c-" + val;
                }
            }

            function addLog(periodStr, text, type) {
                const box = document.getElementById('logBox');
                if (!box) return;

                if (box.innerText.includes("Waiting")) box.innerHTML = "";

                const div = document.createElement('div');
                div.className = "row";
                const pStr = String(periodStr).slice(-4);
                const icon = type === 'win' ? 'WIN ðŸŸ¢' : (type === 'loss' ? 'LOSS ðŸ”´' : 'SKIP âšª');
                div.innerHTML = `<span>...${pStr}</span><span>${text}</span><span class="${type}">${icon}</span>`;
                box.prepend(div);
            }

            // Bind Button
            const btn = document.getElementById('btnFetch');
            if (btn) {
                btn.addEventListener('click', fetchData);
            }

            // Initial Fetch
            fetchData();
        })();
    </script>
</div>